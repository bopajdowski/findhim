<!DOCTYPE html>
<html>
<head>
  <title>Wizualizacja BTS - {{ uuid }}</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; }
    .topbar {
      padding: 12px 16px;
      border-bottom: 1px solid #e5e5e5;
      background: #fff;
    }
    #map { height: calc(100vh - 58px); width: 100%; }
    .small { color: #666; font-size: 13px; line-height: 1.4; }
    .legend {
      background: #fff;
      border: 1px solid rgba(0,0,0,0.2);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 12px;
      line-height: 1.4;
    }
    .dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; background:#ff0000; }
    .line { display:inline-block; width:22px; height:0; border-top:2px dashed #b30000; margin: 0 6px 3px 0; }
    .ring { display:inline-block; width:10px; height:10px; border-radius:50%; border:2px solid #0066ff; margin-right:6px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div><strong>UUID:</strong> <span style="font-family: monospace;">{{ uuid }}</span></div>
    <div class="small">
      Rekordów: <strong>{{ dane_count }}</strong> |
      BTS do wizualizacji (komplet): <strong>{{ btsy_count }}</strong><br>
      Azymut: 0°=północ, 90°=wschód. Zasięg: metry. Sektor: kt (stopnie), oś = azymut.
    </div>
  </div>

  <div id="map"></div>

  <script>
    const btsy = {{ btsy_json|safe }};

    const map = L.map('map').setView([52.0, 19.0], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const layer = L.layerGroup().addTo(map);
    const bounds = [];

    let cntRange = 0, cntAz = 0, cntSector = 0, cntOmni = 0;

    btsy.forEach((bts) => {
      const parts = String(bts.coords || '').split(',');
      const lat = Number(parts[0]);
      const lon = Number(parts[1]);
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;

      const az = Number(bts.azymut);
      const kt = Number(bts.kt);
      const zas = Number(bts.zasieg);

      if (!Number.isFinite(az) || !Number.isFinite(kt) || !Number.isFinite(zas)) return;

      bounds.push([lat, lon]);

      const isOmni = kt >= 360;
      const hasSector = kt > 0 && kt < 360;

      // Punkt BTS
      L.circleMarker([lat, lon], {
        radius: 6,
        color: '#333',
        weight: 1,
        fillColor: '#ff0000',
        fillOpacity: 0.95
      }).addTo(layer).bindPopup(`
        <strong>${bts.bts ? bts.bts : 'BTS'}</strong><br>
        Typ: ${bts.typ ? bts.typ : ''}<br><br>
        Azymut: ${az}°<br>
        Kąt: ${kt}°<br>
        Zasięg: ${zas} m<br>
        Tryb: ${isOmni ? 'dookólna (360°)' : 'sektor'}<br>
      `);

      // Okrąg zasięgu w metrach
      cntRange += 1;
      L.circle([lat, lon], {
        radius: zas,
        color: '#0066ff',
        weight: 1,
        opacity: 0.25,
        fillOpacity: 0.0
      }).addTo(layer);

      // Linia azymutu (turf: [lon,lat], km)
      cntAz += 1;
      const end = turf.destination([lon, lat], zas / 1000.0, az, { units: 'kilometers' });
      const endLat = end.geometry.coordinates[1];
      const endLon = end.geometry.coordinates[0];

      L.polyline([[lat, lon], [endLat, endLon]], {
        color: '#b30000',
        weight: 2,
        dashArray: '6 10',
        opacity: 0.85
      }).addTo(layer);

      // Sektor jako wycinek koła (arcPoints) tylko dla 0<kt<360
      if (hasSector) {
        cntSector += 1;

        const start = az - (kt / 2.0);
        const stop  = az + (kt / 2.0);

        const steps = 60;
        const arc = [];
        for (let i = 0; i <= steps; i++) {
          const bearing = start + ((stop - start) * (i / steps));
          const p = turf.destination([lon, lat], zas / 1000.0, bearing, { units: 'kilometers' });
          arc.push([p.geometry.coordinates[1], p.geometry.coordinates[0]]); // [lat,lon]
        }

        const sectorLatLngs = [[lat, lon], ...arc, [lat, lon]];
        L.polygon(sectorLatLngs, {
          color: '#0066ff',
          weight: 1,
          opacity: 0.6,
          fillColor: '#0066ff',
          fillOpacity: 0.18
        }).addTo(layer);
      } else if (isOmni) {
        cntOmni += 1;
        // dookólna: sam okrąg zasięgu (sektor pomijamy)
      }
    });

    if (bounds.length) {
      map.fitBounds(bounds, { padding: [20, 20], maxZoom: 16 });
    }

    console.log('DEBUG counts:', {
      total_btsy: btsy.length,
      range_circles: cntRange,
      azymut_lines: cntAz,
      sectors: cntSector,
      omni: cntOmni
    });

    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = `
        <div><span class="dot"></span> BTS (komplet danych)</div>
        <div style="margin-top:6px;"><span class="line"></span> Linia azymutu</div>
        <div><span class="ring"></span> Zasięg (okrąg; metry)</div>
        <div>Wycinek: sektor (0&lt;kt&lt;360; oś=azymut)</div>
        <div>kt=360: dookólna (sam okrąg)</div>
      `;
      return div;
    };
    legend.addTo(map);
  </script>
</body>
</html>
