<!DOCTYPE html>
<html>
<head>
    <title>üó∫Ô∏è BTS Coverage Map - {{ uuid }}</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #fff; padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .header h1 { font-size: 18px; color: #333; }
        .stats { font-size: 14px; color: #666; }
        #map { flex: 1; width: 100%; z-index: 1; }
        .legend { background: white; padding: 10px; border-radius: 4px; border: 2px solid rgba(0,0,0,0.2); font-size: 12px; line-height: 1.5; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .legend .line { height: 3px; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Wizualizacja Zasiƒôgu BTS</h1>
        <div class="stats">
            UUID: <span style="font-family: monospace;">{{ uuid }}</span> |
            Rekordy: <strong>{{ dane_count }}</strong> |
            Zgeo: <strong>{{ btsy_count }}</strong>
        </div>
    </div>

    <div id="map"></div>

    <script>
        // 1. DANE Z DJANGO (JSON)
        const btsy = {{ btsy_json|safe }};

        // 2. INICJALIZACJA MAPY
        const map = L.map('map').setView([52.0, 19.0], 6); // Polska default
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const bounds = [];
        const layerGroup = L.layerGroup().addTo(map);

        // 3. RYSOWANIE BTS√ìW
        btsy.forEach((bts, index) => {
            try {
                // Parsowanie koordynat√≥w "lat,lon"
                const parts = bts.coords.split(',');
                const lat = parseFloat(parts[0]);
                const lon = parseFloat(parts[1]);

                if (isNaN(lat) || isNaN(lon)) return;

                const pos = [lat, lon];
                bounds.push(pos);

                // Parametry wizualizacji
                const azimuth = parseFloat(bts.azymut) || 0;
                const beamWidth = parseFloat(bts.kt) || 60; // Domy≈õlny kƒÖt je≈õli brak
                const rangeMeters = parseFloat(bts.zasieg) || 500; // Domy≈õlny zasiƒôg je≈õli brak
                const rangeKm = rangeMeters / 1000;

                // A. MARKER (Kropka)
                L.circleMarker(pos, {
                    radius: 6,
                    color: '#333',
                    weight: 1,
                    fillColor: '#ff0000',
                    fillOpacity: 0.9
                }).addTo(layerGroup).bindPopup(`
                    <strong>${bts.bts || 'BTS'}</strong><br>
                    Typ: ${bts.typ}<br>
                    Azymut: ${azimuth}¬∞<br>
                    KƒÖt: ${beamWidth}¬∞<br>
                    Zasiƒôg: ${rangeMeters}m
                `);

                // B. SEKTOR (Wycinek ko≈Ça) - tylko je≈õli jest azymut
                if (azimuth !== 0 || beamWidth > 0) {
                    const centerPoint = turf.point([lon, lat]); // Turf u≈ºywa [lon, lat]!
                    const options = {steps: 64, units: 'kilometers'};

                    // Obliczanie kƒÖt√≥w start/stop
                    const angleStart = azimuth - (beamWidth / 2);
                    const angleEnd = azimuth + (beamWidth / 2);

                    // Rysowanie ≈Çuku (sector) za pomocƒÖ Turf.js
                    // Turf sector: center, radius, bearing1, bearing2
                    const sectorPoly = turf.sector(
                        [lon, lat],
                        rangeKm,
                        angleStart,
                        angleEnd,
                        options
                    );

                    // Konwersja GeoJSON -> Leaflet
                    L.geoJSON(sectorPoly, {
                        style: {
                            color: '#0066ff',
                            weight: 1,
                            opacity: 0.6,
                            fillColor: '#0066ff',
                            fillOpacity: 0.15
                        }
                    }).addTo(layerGroup);

                    // C. LINIA AZYMUTU (Przerywana)
                    const destPoint = turf.destination(centerPoint, rangeKm, azimuth, options);
                    // Leaflet u≈ºywa [lat, lon]
                    const latLngDest = [destPoint.geometry.coordinates[1], destPoint.geometry.coordinates[0]];

                    L.polyline([pos, latLngDest], {
                        color: 'red',
                        weight: 2,
                        dashArray: '5, 10',
                        opacity: 0.8
                    }).addTo(layerGroup);
                }

            } catch (e) {
                console.error("B≈ÇƒÖd rysowania BTS:", bts, e);
            }
        });

        // 4. DOPASOWANIE WIDOKU
        if (bounds.length > 0) {
            map.fitBounds(bounds, {padding: [50, 50]});
        }

        // 5. LEGENDA
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function (map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <h4>Legenda</h4>
                <div><i style="background: #ff0000; border-radius: 50%"></i> Lokalizacja BTS</div>
                <div><i style="background: #0066ff; opacity: 0.3"></i> Sektor pokrycia</div>
                <div><i class="line" style="border-top: 2px dashed red"></i> Kierunek g≈Ç√≥wny (Azymut)</div>
            `;
            return div;
        };
        legend.addTo(map);

    </script>
</body>
</html>
